// מאגר ידע מתקדם על סדרות סיפורי ילדים

export const SERIES_KNOWLEDGE = {
  'פיפ ופוזי': {
    name: 'פיפ ופוזי',
    englishName: 'Pip and Posy',
    characters: {
      main: [
        {
          name: 'פיפ',
          type: 'ארנב',
          description: 'ארנב כתום חמוד ואנרגטי, אוהב להוביל ולחקור',
          personality: 'נלהב, אופטימי, לפעמים קצת חסר סבלנות',
          appearance: 'ארנב כתום בהיר עם אוזניים ארוכות וזנב קטן לבן'
        },
        {
          name: 'פוזי',
          type: 'עכבר',
          description: 'עכברה ורודה עדינה ומתחשבת',
          personality: 'סבלנית, חכמה, אכפתית, מתחשבת ברגשות אחרים',
          appearance: 'עכברה ורודה בהירה עם זנב ארוך ועיניים גדולות'
        }
      ],
      supporting: [
        {
          name: 'זאק',
          type: 'דוב',
          description: 'דוב חום גדול וידידותי',
          personality: 'חבר טוב, מגן ותומך'
        }
      ]
    },
    writingStyle: {
      tone: 'חם, ידידותי, פשוט ונגיש לילדים צעירים',
      language: 'משפטים קצרים וברורים, מילים יומיומיות',
      themes: 'חברות, שיתוף, פתרון קונפליקטים, רגשות',
      structure: 'סיפורים קצרים עם בעיה פשוטה ופתרון חיובי',
      dialogue: 'דיאלוגים קצרים וטבעיים בין החברים'
    },
    visualStyle: {
      artStyle: 'איורים מאויירים בסגנון ילדותי חם וידידותי',
      colors: 'צבעים בהירים ועדינים - כתום לפיפ, ורוד לפוזי',
      setting: 'בית, גינה, חצר משחקים, סביבה ביתית נעימה',
      mood: 'חמימות, בטיחות, שמחה ילדותית'
    },
    typicalScenarios: [
      'משחקים יחד ועולה קונפליקט קטן',
      'אחד עוזר לשני בבעיה',
      'גילוי דברים חדשים יחד',
      'שיתוף צעצועים או פעילויות',
      'הכנות לאירועים מיוחדים'
    ]
  },

  'דוב קטן': {
    name: 'דוב קטן',
    englishName: 'Little Bear',
    characters: {
      main: [
        {
          name: 'דוב קטן',
          type: 'דוב',
          description: 'דוב צעיר סקרן ומתוק',
          personality: 'סקרן, אהוב, תמים, אוהב ללמוד ולחקור',
          appearance: 'דוב חום קטן עם פרווה רכה וחמימה'
        },
        {
          name: 'אמא דוב',
          type: 'דוב בוגר',
          description: 'אמא חמה ואוהבת',
          personality: 'סבלנית, חכמה, מגינה ותומכת',
          appearance: 'דובה חומה גדולה עם סינר ולבוש ביתי'
        }
      ],
      supporting: [
        {
          name: 'ינשוף',
          type: 'ינשוף',
          description: 'ינשוף חכם וידידותי',
          personality: 'חכם, מנוסה, נותן עצות טובות'
        },
        {
          name: 'ברווז',
          type: 'ברווז',
          description: 'ברווז שובב ומהיר',
          personality: 'שובב, מהיר, אוהב הרפתקאות'
        }
      ]
    },
    writingStyle: {
      tone: 'חם, משפחתי, מעורר געגועים וחמימות',
      language: 'שפה פשוטה אך עשירה, תיאורי טבע יפים',
      themes: 'משפחה, אהבה, גדילה, חקירת העולם',
      structure: 'סיפורי יומיום פשוטים עם לקח חיים',
      dialogue: 'שיחות חמות בין דוב קטן לאמא או לחברים'
    },
    visualStyle: {
      artStyle: 'איורים קלאסיים בסגנון ציור יד חם',
      colors: 'גוונים חמים - חום, ירוק יער, כחול שמיים',
      setting: 'יער, בית עץ, טבע פתוח, חצר הבית',
      mood: 'שלווה, חמימות משפחתית, טבעיות'
    },
    typicalScenarios: [
      'הרפתקאות ביער',
      'שיחות חמות עם אמא דוב',
      'גילוי דברים חדשים בטבע',
      'פגישות עם חיות יער',
      'למידה על עונות השנה'
    ]
  },

  'תומס הקטר': {
    name: 'תומס הקטר',
    englishName: 'Thomas the Tank Engine',
    characters: {
      main: [
        {
          name: 'תומס',
          type: 'קטר',
          description: 'קטר כחול קטן ואנרגטי',
          personality: 'נלהב, מהיר, לפעמים חסר סבלנות אבל בעל לב טוב',
          appearance: 'קטר כחול בהיר עם פנים מחייכות ומספר 1'
        },
        {
          name: 'פרסי',
          type: 'קטר',
          description: 'קטר ירוק קטן וידידותי',
          personality: 'נאמן, מועיל, אמין',
          appearance: 'קטר ירוק עם מספר 6'
        },
        {
          name: 'ג\'יימס',
          type: 'קטר',
          description: 'קטר אדום יהיר אבל בעל לב טוב',
          personality: 'גאה, לפעמים יהיר, אבל חבר אמיתי',
          appearance: 'קטר אדום מבריק עם מספר 5'
        }
      ],
      supporting: [
        {
          name: 'גורדון',
          type: 'קטר גדול',
          description: 'הקטר הגדול והמהיר ביותר',
          personality: 'גאה, מנוסה, לפעמים מתנשא אבל טוב בלב'
        }
      ]
    },
    writingStyle: {
      tone: 'הרפתקני, אופטימי, מלמד על עבודת צוות',
      language: 'משפטים ברורים עם מושגים של רכבות ועבודה',
      themes: 'עבודת צוות, אחריות, עזרה הדדית, כבוד לעבודה',
      structure: 'משימות וחוויות עם תחילה, בעיה ופתרון',
      dialogue: 'דיאלוגים בין הקטרים עם הרבה אמירות מעודדות'
    },
    visualStyle: {
      artStyle: 'איורים צבעוניים וברורים של רכבות ונופי כפר',
      colors: 'צבעים חזקים וברורים - כחול, אדום, ירוק, צהוב',
      setting: 'תחנות רכבת, מסילות, כפר אנגלי, נופים כפריים',
      mood: 'אנרגטי, מלא תנועה, אופטימי'
    },
    typicalScenarios: [
      'משימות הובלה ברכבת',
      'בעיות במסילות שצריך לפתור',
      'תחרויות ידידותיות בין קטרים',
      'עזרה לתושבי האי',
      'לקחים על עבודת צוות'
    ]
  },

  'פו הדוב': {
    name: 'פו הדוב',
    englishName: 'Winnie the Pooh',
    characters: {
      main: [
        {
          name: 'פו',
          type: 'דוב צעצועי',
          description: 'דוב דבש צהוב וחמוד',
          personality: 'תמים, אוהב דבש, חכמות פשוטות, חם ואוהב',
          appearance: 'דוב צהוב שמנמן עם חולצה אדומה קטנה'
        },
        {
          name: 'כריסטופר רובין',
          type: 'ילד',
          description: 'הילד שהוא הבעלים של כל הצעצועים',
          personality: 'חכם, אוהב, מובן מאליו שהוא המנהיג',
          appearance: 'ילד בלונדיני עם בגדים פשוטים'
        }
      ],
      supporting: [
        {
          name: 'ארנבת',
          type: 'ארנב',
          description: 'ארנב מקפיד ומאורגן',
          personality: 'מדויק, אחראי, קצת לחוץ'
        },
        {
          name: 'יער',
          type: 'עוף',
          description: 'ינשוף חכם אבל קצת מבולבל',
          personality: 'חכם, מנסה להיות רציני'
        },
        {
          name: 'טיגר',
          type: 'נמר',
          description: 'נמר קופצני ואנרגטי',
          personality: 'שמח, אנרגטי, אופטימי'
        }
      ]
    },
    writingStyle: {
      tone: 'פילוסופי-ילדותי, חכמות פשוטות, הומור עדין',
      language: 'שפה עשירה אך פשוטה, המון דמיון ופיוט',
      themes: 'חברות, חכמות חיים פשוטות, דמיון, ילדות',
      structure: 'הרפתקאות ביער עם הרהורים ולקחים',
      dialogue: 'דיאלוגים חכמים וחמימים עם הרבה הומור'
    },
    visualStyle: {
      artStyle: 'איורים קלאסיים ברוח הספרים המקוריים',
      colors: 'גוונים חמים ורכים - צהוב, אדום, ירוק יער',
      setting: 'יער מאה אחוז אקר, בתים בעצים, נופי יער',
      mood: 'חמימות נוסטלגית, שלווה, ילדות תמימה'
    },
    typicalScenarios: [
      'חיפוש אחר דבש',
      'הרפתקאות ביער עם החברים',
      'פתרון בעיות בדרכים יצירתיות',
      'למידה על חברות',
      'גילוי חכמות פשוטות של החיים'
    ]
  },

  'רחוב סומסום': {
    name: 'רחוב סומסום',
    englishName: 'Sesame Street',
    characters: {
      main: [
        {
          name: 'אלמו',
          type: 'מפלצת אדומה',
          description: 'מפלצת אדומה קטנה ושמחה',
          personality: 'שמח, סקרן, אוהב ללמוד, מדבר בגוף שלישי',
          appearance: 'מפלצת אדומה פרוותית עם עיניים גדולות'
        },
        {
          name: 'עוגי',
          type: 'מפלצת כחולה',
          description: 'מפלצת כחולה שאוהבת עוגיות',
          personality: 'תמיד רעב לעוגיות, חברותי, מצחיק',
          appearance: 'מפלצת כחולה גדולה עם פה ענק'
        },
        {
          name: 'ברט וארני',
          type: 'בובות',
          description: 'זוג חברים הגרים יחד',
          personality: 'ברט - רציני ומאורגן, ארני - שובב ומצחיק',
          appearance: 'ברט - צהוב עם שיער פיקסל, ארני - כתום עם פסים'
        }
      ]
    },
    writingStyle: {
      tone: 'חינוכי, מצחיק, מלמד ערכים ומיומנויות',
      language: 'שפה פשוטה וחזרות ללמידה',
      themes: 'למידה, ספירה, אותיות, ערכים חברתיים',
      structure: 'למידה דרך משחק ושירים',
      dialogue: 'דיאלוגים משעשעים עם חזרות ושירים'
    },
    visualStyle: {
      artStyle: 'צבעוני וחי, סגנון בובות וקרטון',
      colors: 'צבעים זוהרים וחזקים - אדום, כחול, צהוב, ירוק',
      setting: 'רחוב עירוני ידידותי עם בתים צבעוניים',
      mood: 'שמח, אנרגטי, חינוכי'
    },
    typicalScenarios: [
      'למידת אותיות ומספרים',
      'שירים וריקודים',
      'לקחים על חברות ושיתוף',
      'גילוי דברים חדשים ברחוב',
      'פתרון בעיות יחד'
    ]
  }
};

// פונקציה לזיהוי סדרה מטקסט חופשי
export function identifySeries(userInput) {
  if (!userInput) return null;
  
  const input = userInput.toLowerCase().trim();
  
  // חיפוש מדויק לפי שמות
  for (const [key, series] of Object.entries(SERIES_KNOWLEDGE)) {
    const hebrewName = series.name.toLowerCase();
    const englishName = series.englishName.toLowerCase();
    
    if (input.includes(hebrewName) || input.includes(englishName)) {
      return series;
    }
  }
  
  // חיפוש לפי שמות דמויות
  for (const [key, series] of Object.entries(SERIES_KNOWLEDGE)) {
    const characters = [...series.characters.main, ...(series.characters.supporting || [])];
    
    for (const character of characters) {
      if (input.includes(character.name.toLowerCase())) {
        return series;
      }
    }
  }
  
  return null;
}

// פונקציה ליצירת פרומפט מותאם לסדרה
export function createSeriesAwarePrompt(series, formData) {
  if (!series) return null;
  
  const { characters, writingStyle, visualStyle, typicalScenarios } = series;
  
  return {
    storyPrompt: `
אתה כותב סיפור בסגנון ${series.name} (${series.englishName}).

דמויות שחייבות להופיע בסיפור:
${characters.main.map(char => 
  `- ${char.name}: ${char.description}. אישיות: ${char.personality}. מראה: ${char.appearance}`
).join('\n')}

${characters.supporting ? `דמויות נוספות זמינות:
${characters.supporting.map(char => 
  `- ${char.name}: ${char.description}. אישיות: ${char.personality}`
).join('\n')}` : ''}

סגנון כתיבה חובה:
- טון: ${writingStyle.tone}
- שפה: ${writingStyle.language}
- נושאים מרכזיים: ${writingStyle.themes}
- מבנה: ${writingStyle.structure}
- דיאלוגים: ${writingStyle.dialogue}

סצנות טיפוסיות לסדרה זו:
${typicalScenarios.map(scenario => `- ${scenario}`).join('\n')}

חשוב מאוד: 
1. הדמויות חייבות להתנהג בדיוק כמו בסדרה המקורית
2. השפה והטון חייבים להיות זהים לסדרה
3. הסיטואציות חייבות להתאים לעולם של הסדרה
4. שמור על הרוח והאופי של הסדרה המקורית
`,

    visualPrompt: `
in the exact art style of ${series.englishName}, 
${visualStyle.artStyle}, 
featuring the original characters: ${characters.main.map(char => char.name).join(', ')},
${visualStyle.colors},
setting: ${visualStyle.setting},
mood: ${visualStyle.mood},
must look exactly like the original ${series.englishName} illustrations
`
  };
}

// פונקציה לחלוקת סיפור לסצנות
export function divideStoryIntoScenes(story, targetScenes = 3) {
  const paragraphs = story.split('\n').filter(p => p.trim().length > 0);
  const scenes = [];
  const paragraphsPerScene = Math.ceil(paragraphs.length / targetScenes);
  
  for (let i = 0; i < targetScenes; i++) {
    const startIndex = i * paragraphsPerScene;
    const endIndex = Math.min((i + 1) * paragraphsPerScene, paragraphs.length);
    const sceneParagraphs = paragraphs.slice(startIndex, endIndex);
    
    if (sceneParagraphs.length > 0) {
      scenes.push({
        sceneNumber: i + 1,
        content: sceneParagraphs.join('\n'),
        summary: generateSceneSummary(sceneParagraphs)
      });
    }
  }
  
  return scenes;
}

// פונקציה ליצירת תקציר סצנה לתמונה
function generateSceneSummary(paragraphs) {
  const content = paragraphs.join(' ');
  
  // חיפוש אחר פעולות ודמויות מרכזיות
  const actionWords = ['הולך', 'רץ', 'משחק', 'אוכל', 'מחפש', 'פוגש', 'מוצא', 'עוזר', 'בונה', 'יוצר'];
  const actions = actionWords.filter(word => content.includes(word));
  
  // חיצוי ביטויים מרכזיים (המילים הראשונות של המשפט הראשון)
  const firstSentence = paragraphs[0].split('.')[0];
  
  return firstSentence.length > 100 ? firstSentence.substring(0, 100) + '...' : firstSentence;
}
